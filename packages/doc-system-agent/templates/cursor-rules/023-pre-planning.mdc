---
description: Pre-Planning Checklisten für proaktive Fehlervorbeugung. Aktiviert bei Anfragen wie "plane", "implementiere", "ändere", "refactore".
globs: []
alwaysApply: false
---

# Pre-Planning Checklisten

Diese Checklisten helfen dem Agent, Fehler zu vermeiden, BEVOR sie implementiert werden. Basierend auf historischen Fixes (ADR-001 bis ADR-017).

## 1. Vor Scanner-Änderungen

**Datei:** `src/core/scanner.ts`

### Checkliste

- [ ] Sind alle irrelevanten Verzeichnisse in `DEFAULT_EXCLUDES`?
  - `.ai-agent-context`, `.vscode`, `.cursor`, `node_modules`, `.git`
- [ ] Ist die `.gitignore` aktuell? (Scanner nutzt sie, Zeile 39-46)
- [ ] Werden Backup-Dateien korrekt gefiltert? (`BACKUP_DIR_NAMES`, `BACKUP_FILE_SUFFIXES`)
- [ ] Ist die Sortierung deterministisch? (`entries.sort()`, Zeile 90)

### Verification Commands

```bash
# Datei existiert prüfen
Test-Path src/core/scanner.ts  # PowerShell
ls -la src/core/scanner.ts      # Bash

# DEFAULT_EXCLUDES prüfen
Select-String -Path src/core/scanner.ts -Pattern "DEFAULT_EXCLUDES"  # PowerShell
grep "DEFAULT_EXCLUDES" src/core/scanner.ts                         # Bash

# Sortierung prüfen
Select-String -Path src/core/scanner.ts -Pattern "entries\.sort"  # PowerShell
grep "entries\.sort" src/core/scanner.ts                          # Bash

# Nach Änderungen kompilieren
npm run compile
```

### Relevante ADRs

- Keine direkten ADRs, aber Scanner-Bugs führen zu Index-Rauschen

---

## 2. Vor Parser-Änderungen

**Dateien:** `src/parsers/ts-js.ts`, `src/parsers/json-yaml.ts`, `src/parsers/python.ts`

### Checkliste

- [ ] Führt die Änderung zu Hash-Änderungen? (Signatur-Hash in `src/core/symbols.ts`)
- [ ] Sind alle Symbol-Typen konsistent behandelt?
  - `class`, `interface`, `type`, `enum`, `function`, `method`, `variable`, `module`
- [ ] Wird `getTypeNode()` vor `getType()` bevorzugt? (Zeilen 56-64 in ts-js.ts)
- [ ] Sind Standard-Libs geladen? (`skipLoadingLibFiles: false`)
- [ ] Sind JSON/YAML-Symbole semantisch relevant?
  - `package.json` Keys: relevant
  - Backup-Dateien: irrelevant

### Verification Commands

```bash
# Parser-Dateien existieren prüfen
Test-Path src/parsers/ts-js.ts      # PowerShell
Test-Path src/parsers/json-yaml.ts  # PowerShell
Test-Path src/parsers/python.ts      # PowerShell

# getTypeNode() Pattern prüfen
Select-String -Path src/parsers/ts-js.ts -Pattern "getTypeNode"  # PowerShell
grep "getTypeNode" src/parsers/ts-js.ts                          # Bash

# skipLoadingLibFiles prüfen
Select-String -Path src/parsers/ts-js.ts -Pattern "skipLoadingLibFiles"  # PowerShell
grep "skipLoadingLibFiles" src/parsers/ts-js.ts                        # Bash

# Signatur-Hash-Funktion prüfen
Select-String -Path src/core/symbols.ts -Pattern "hash|Hash"  # PowerShell
grep "hash\|Hash" src/core/symbols.ts                          # Bash

# Nach Änderungen kompilieren und testen
npm run compile
npm run scan:cli
```

### Relevante ADRs

- **ADR-004**: Symbol-typ-spezifische Formatierung
- **ADR-005**: TypeNode vor getType()
- **ADR-006**: Variablen-Typen präziser
- **ADR-007**: Standard-Libs laden

---

## 3. Vor Validator-Änderungen

**Datei:** `src/validator/signature-matching.ts`

### Checkliste

- [ ] Ist die Formatierung identisch mit dem Generator?
  - `renderModuleDoc()` in `module-doc.ts` vergleichen
  - `formatSignatureForDoc()` in `signature-matching.ts` vergleichen
- [ ] Werden alle Symbol-Typen validiert? (Keine `continue` für bestimmte Typen)
- [ ] Sind Toleranz-Regeln semantisch korrekt?
  - `isArchitecturallyValid()` – generisch oder hardcoded?
  - `isOptionalFieldCompatible()` – mehrzeilige Interfaces?
  - `isGenericTypeSimplification()` – zu tolerant bei `{}`?
- [ ] Werden optionale Parameter mit `?` markiert? (Zeile 74)

### Verification Commands

```bash
# Validator-Datei existiert prüfen
Test-Path src/validator/signature-matching.ts  # PowerShell
ls -la src/validator/signature-matching.ts    # Bash

# Formatierungs-Funktionen vergleichen
Select-String -Path src/generator/module-doc.ts -Pattern "renderModuleDoc"  # PowerShell
Select-String -Path src/validator/signature-matching.ts -Pattern "formatSignatureForDoc"  # PowerShell

# Toleranz-Funktionen prüfen
Select-String -Path src/validator/signature-matching.ts -Pattern "isArchitecturallyValid|isOptionalFieldCompatible|isGenericTypeSimplification"  # PowerShell
grep "isArchitecturallyValid\|isOptionalFieldCompatible\|isGenericTypeSimplification" src/validator/signature-matching.ts  # Bash

# Optional-Parameter-Markierung prüfen
Select-String -Path src/validator/signature-matching.ts -Pattern "\?"  # PowerShell
grep "?" src/validator/signature-matching.ts                          # Bash

# Nach Änderungen kompilieren und validieren
npm run compile
npm run validate:cli
```

### Relevante ADRs

- **ADR-001**: Signatur-Abweichung-Fix (hardcoded Patterns)
- **ADR-004**: Validator Signature-Matching Reparatur
- **ADR-013**: System-Funktionalitäts-Fixes
- **ADR-017**: Optional-Feld-Kompatibilität

---

## 4. Vor Generator-Änderungen

**Dateien:** `src/generator/module-doc.ts`, `src/generator/index.ts`

### Checkliste

- [ ] Ist die Formatierung konsistent mit dem Validator?
- [ ] Werden optionale Parameter mit `?` markiert? (Zeile 341)
- [ ] Ist die Sortierung deterministisch? (`compareBlocks()`)
- [ ] Werden Change-Kommentare korrekt generiert?

### Verification Commands

```bash
# Generator-Dateien existieren prüfen
Test-Path src/generator/module-doc.ts  # PowerShell
Test-Path src/generator/index.ts       # PowerShell

# compareBlocks() Funktion prüfen
Select-String -Path src/generator/module-doc.ts -Pattern "compareBlocks"  # PowerShell
grep "compareBlocks" src/generator/module-doc.ts                         # Bash

# Optional-Parameter-Markierung prüfen
Select-String -Path src/generator/module-doc.ts -Pattern "\?"  # PowerShell
grep "?" src/generator/module-doc.ts                          # Bash

# Nach Änderungen kompilieren, scannen und validieren
npm run compile
npm run scan:cli
npm run validate:cli
```

### Relevante ADRs

- **ADR-003**: Documentation Generation Bugs
- **ADR-011**: Module Doc Change Tracking

---

## 5. Vor Cache-Änderungen

**Dateien:** `src/cache/*.ts`, `src/core/consolidation.ts`

### Checkliste

- [ ] Wird `isFirstRun` ZUERST geprüft, vor Git-Filter?
- [ ] Ist die Union-Logik korrekt?
  - `parsedFiles` = tatsächlich geparste Dateien
  - `deletedFiles` = aus Git erkannte Löschungen
  - Alte Einträge nur behalten wenn Datei nicht geparst UND nicht gelöscht
- [ ] Ist die Cache-Version korrekt? (`version: 1`)
- [ ] Gibt es null-Fallbacks bei korruptem Cache?

### Verification Commands

```bash
# Cache-Dateien existieren prüfen
Get-ChildItem -Path src/cache -Filter "*.ts"  # PowerShell
ls src/cache/*.ts                              # Bash

# isFirstRun Pattern prüfen
Select-String -Path src/cache -Pattern "isFirstRun" -Recurse  # PowerShell
grep -r "isFirstRun" src/cache/                               # Bash

# Union-Logik prüfen
Select-String -Path src/core/consolidation.ts -Pattern "parsedFiles|deletedFiles"  # PowerShell
grep "parsedFiles\|deletedFiles" src/core/consolidation.ts                         # Bash

# Cache-Version prüfen
Select-String -Path src/cache -Pattern '"version"' -Recurse  # PowerShell
grep -r '"version"' src/cache/                              # Bash

# Nach Änderungen kompilieren und Cache-Verhalten testen
npm run compile
npm run scan:cli  # Testet Cache-Verhalten
```

### Relevante ADRs

- **ADR-008**: Dependencies-Cache Phase 1
- **ADR-009**: Consolidation Union Logic
- **ADR-013**: "Generate twice" Problem

---

## 6. Anti-Patterns vermeiden

### Hardcoded Pattern-Fixes

```typescript
// SCHLECHT: Hardcoded Toleranz
if ((expected === 'Plugin()' && documented === 'PluginApiResponse()')) {
    return true;
}

// BESSER: Generische Pattern-Erkennung
if (isResponseWrapperPattern(expected, documented)) {
    return true;
}
```

### Signatur-Hash-Instabilität

```typescript
// ACHTUNG: Parser-Verbesserungen ändern den Hash
// z.B. "add():" → "add(a:number,b:number):CalculationResult"
// Das ist normal und führt zu vielen CHANGE_REPORT-Einträgen
```

### Generator/Validator Inkonsistenz

```typescript
// Generator und Validator MÜSSEN identisch formatieren
// Sonst gibt es False-Positive Mismatches
```

---

## 7. Nach Änderungen: End-to-End Verification

**WICHTIG:** Siehe `026-reality-driven-verification.mdc` für vollständige Verification-Checkliste.

### Verification Commands

```bash
# PowerShell (Windows)
npm run compile
npm run scan:cli
npm run validate:cli
npm test

# Bash (Linux/Mac)
npm run compile
npm run scan:cli
npm run validate:cli
npm test
```

### Success Criteria

Eine Änderung ist **NUR** dann abgeschlossen, wenn:

- ✅ Code kompiliert ohne Fehler (`npm run compile`)
- ✅ Scan funktioniert (`npm run scan:cli`)
- ✅ Validierung funktioniert (`npm run validate:cli`)
- ✅ Tests bestehen (`npm test`)
- ✅ **Evidence bereitgestellt:** Nie "Ich habe X implementiert" ohne Beweis

Bei signifikanten Änderungen: ADR in `docs/adr/` erstellen.
